<!DOCTYPE html>
<html>
<head></head>
<body>
<header>
    <img id="logo" src="https://raw.githubusercontent.com/rdgd/twly/master/assets/towel.png" alt="TWLY Logo" />
    <h1>TWLY</h1>
    <link rel="stylesheet" type="text/css" href="/assets/main.css" />
    <script src="https://use.fontawesome.com/4188df2258.js"></script>
</header>
<section id="search">
  <div class="card">
    <form>
      <fieldset>
        <h4>Account Name</h4>
        <input id="name" type="text" name="name">
        <i class="validation-icon fa"></i>
      </fieldset>
      <fieldset class="radios">
        <h4>Account Type</h4>
        <div class="fs-wrap">
          <fieldset class="selected">
            <input id="user" type="radio" checked name="accountType" />
            <label for="user">User</label>
          </fieldset>
          <fieldset>
            <input id="organization" type="radio" name="accountType" />
            <label for="organization">Organization</label>
          </fieldset>
        </div>
      </fieldset>
      <fieldset class="radios">
        <h4>Repo Analysis</h4>
        <div class="fs-wrap">
          <fieldset class="selected">
            <input id="independent" checked type="radio" name="analysisType" />
            <label for="independent">Independent</label>
          </fieldset>
          <fieldset>
            <input id="together" type="radio" name="analysisType" />
            <label for="together">Together</label>
          </fieldset>
        </div>
      </fieldset>
      <hr>
      <br>
      <button type="button" disabled id="submit">Analyze!</button>
    </form>
  </div>
</section>
<section id="results">
</section>
<footer>

</footer>
<script>
var nameInput = document.getElementById('name');
nameInput.addEventListener('blur', (e) => {
  var http = new XMLHttpRequest();
  var url = 'https://api.github.com/users/' + e.target.value;
  var validationIcon = nameInput.parentElement.querySelector('.validation-icon');
  http.responseType = 'json';
  http.open('GET', url, true);
  showProgress(validationIcon);
  http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  http.onreadystatechange = function () { //Call a function when the state changes.
    if(http.readyState === 4) {
      if (http.status === 200) {
        showValidated(validationIcon);
      } else if (http.status === 404) {
        showInvalid(validationIcon);
      }
    }
  }
  http.send();
});

function showValidated (i) {
  i.classList = '';
  i.classList.add('show', 'validation-icon', 'fa', 'fa-check-circle');
}

function showInvalid (i) {
  i.classList = '';
  i.classList.add('show', 'validation-icon', 'fa', 'fa-times-circle');
}

function showProgress (i) {
  i.classList = '';
  i.classList.add('show', 'validation-icon', 'fa', 'fa-spin', 'fa-circle-o-notch');
}

var submitBtn = document.getElementById('submit');
submitBtn.addEventListener('click', function (e) {
  var http = new XMLHttpRequest();
  var url = "/git/user";
  var name = document.getElementById('name');
  var params = "name=" + name.value;
  http.responseType = 'json';
  http.open("POST", url, true);

  //Send the proper header information along with the request
  http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

  http.onreadystatechange = function () { //Call a function when the state changes.
    if(http.readyState == 4 && http.status == 200) {
      displayResults(http.response);
    }
  }
  http.send(params);
});

var radios = Array.from(document.querySelectorAll('[type="radio"]'));
radios.forEach((r) => {
  r.addEventListener('change', (e) => {
    let prevEl = e.target.parentElement.previousElementSibling;
    let nextEl = e.target.parentElement.nextElementSibling;
    (prevEl && prevEl.type === 'fieldset') ? prevEl.classList.remove('selected') : nextEl.classList.remove('selected');
    e.target.parentElement.classList.add('selected');
  });
});

function displayResults (results) {
  let resultContainer = document.getElementById('results');
  results.forEach((r) => {
    let resultHeading = document.createElement('header');
    let repoName = document.createElement('h1');
    let summaryHeading = document.createElement('h3');
    let detailsHeading = document.createElement('h3');
    let messages = document.createElement('ul');
    let summary = document.createElement('table');
    let tableHeaders = document.createElement('tr');
    let row = document.createElement('tr');

    repoName.textContent = r.name;
    resultHeading.appendChild(repoName);
    summaryHeading.textContent = 'Summary';
    detailsHeading.textContent = 'Details';

    r.messages.forEach((m) => {
      let pre = document.createElement('pre');
      pre.textContent = m;
      messages.appendChild(document.createElement('li').appendChild(pre));
    });
    if (r.messages.length === 0) {
      let nothing = document.createElement('li');
      nothing.textContent = 'Perfect score. You rock! Way to remember your towel.';
      messages.appendChild(nothing);
    }
    r.summary.Score = r.towelieScore + '%';
    for (let k in r.summary) {
      let tdh = document.createElement('th');
      let td = document.createElement('td');
      tdh.textContent = k;
      tableHeaders.appendChild(tdh);
      td.textContent = r.summary[k];
      row.appendChild(td);
    }
    summary.appendChild(tableHeaders);
    summary.appendChild(row);
    resultContainer.appendChild(resultHeading);
    resultContainer.appendChild(summaryHeading);
    resultContainer.appendChild(summary);
    resultContainer.appendChild(detailsHeading);
    resultContainer.appendChild(messages);
  });
}
</script>
</body>
</html>

